document.addEventListener("DOMContentLoaded",(function(){const csvFilePath="csv/etcitem_data.csv";const tblFilePath="csv/ItemDesc.tbl";const iconFolderPath="icon/";let itemsCache=[];let descMapCache={};function renderitems(items,descMap){const itemGrid=document.querySelector(".item-grid");const fragment=document.createDocumentFragment();items.forEach((item=>{const card=document.createElement("div");card.className="item-card";const iconPath=`${iconFolderPath}${item.invgfx}.gif`;const blessS=item.bless;const blessSDisplay=blessS==0?`受祝福的 `:blessS==2?`受詛咒的 `:"";const minlvl=item.min_lvl;const maxlvl=item.max_lvl;let uselvlDisplay="";if(minlvl>=100){uselvlDisplay=`使用需求: Lv.${minlvl}<br>`}else if(minlvl>0&&maxlvl>0){uselvlDisplay=`使用需求: Lv.${minlvl} - Lv.${maxlvl}<br>`}else if(minlvl==0&&maxlvl>0){uselvlDisplay=`使用需求: 小於 Lv.${maxlvl}<br>`}else if(minlvl>0&&maxlvl==0){uselvlDisplay=`使用需求: Lv.${minlvl}<br>`}const materialMap={iron:"鐵",steel:"金屬",wood:"木頭",leather:"皮",bone:"骨頭",gemstone:"寶石",mithril:"米索莉",blackmithril:"黑色米索莉",silver:"銀",oriharukon:"奧里哈魯根",platinum:"白金",gold:"金",glass:"玻璃",cloth:"布",dragonscale:"龍鱗",animalmatter:"動物性",vegetation:"植物性",liquid:"液體",mineral:"礦石",paper:"紙",copper:"銅",web:"蠟",none:"其它"};const typeMap={potion:"藥水",scroll:"卷軸",treasure_box:"袋子",wand:"魔杖",totem:"圖騰",sting:"飛刀",spellbook:"技能",questitem:"任務",petitem:"寵物",other:"其它",material:"材料",gem:"寶石",light:"照明",food:"食物",firecracker:"煙火",event:"活動",arrow:"箭矢"};const materialInChinese=materialMap[item.material]||item.material;const typeInChinese=typeMap[item.item_type]||item.item_type;const weightInKg=Math.round(parseFloat(item.weight)/1e3);const weightDisplay=weightInKg>0?`重量: ${weightInKg}<br>`:"";const maxchargecountDisplay=item.max_charge_count>0?`使用次數: ${item.max_charge_count}<br>`:"";const itemdmgDisplay=item.dmg_small&&item.dmg_large!=="0"?`攻擊: ${item.dmg_small} / ${item.dmg_large}<br>`:"";const delaytimeSec=parseInt(item.delay_time,10)/1e3;const delaytimeDisplay=!isNaN(delaytimeSec)&&delaytimeSec>0?`延遲: ${delaytimeSec.toFixed(1)} 秒<br>`:"";const stackableDisplay=item.stackable>0?`可以堆疊<br>`:"";const tradeableDisplay=item.trade>0?`不可轉移<br>`:"";const deleteableDisplay=item.cant_delete>0?`不可刪除<br>`:"";const delayEffectSec=parseInt(item.delay_effect,10);let delayEffectDisplay="";if(!isNaN(delayEffectSec)&&delayEffectSec>0){const days=Math.floor(delayEffectSec/86400);const hours=Math.floor(delayEffectSec%86400/3600);const minutes=Math.floor(delayEffectSec%3600/60);const seconds=delayEffectSec%60;let timeStr="";if(days>0)timeStr+=`${days}天 `;if(hours>0)timeStr+=`${hours}小時 `;if(minutes>0)timeStr+=`${minutes}分鐘 `;if(seconds>0)timeStr+=`${seconds}秒`;delayEffectDisplay=`使用間隔: ${timeStr.trim()}`}const petitemDescription=item.item_type==="petitem"?"詳細說明請至遊戲資料庫查看。":"";const classMap={XiaNa_Change_Reel:"效果時間: 1800秒。",Silver_Pumpkin:"開啟隨機獲得限定道具。","shop.UserTitle":"賦予角色封號。","shop.UserSex":"改變角色性別，使用後須重新登入遊戲。","shop.UserName":"改變角色名稱，使用後須重新登入遊戲。","shop.UserColorU":"使用後角色轉為正義。","shop.UserColorD":"使用後角色轉為邪惡。","shop.Up_hm1":"永久提升能力質。","shop.Reset_Hole":"重置裝備的凹槽數量。","shop.ResetPassword":"修改帳號密碼，使用後須重新登入遊戲。","shop.Clan_Honor_Reel":"使用後角色提升至指定等級。","shop.AncientSecretPotion":"使用後短暫提升角色能力:<br>體力上限 +100<br>魔力上限 +100<br>攻擊成功 +10<br>額外攻擊 +5<br>遠距命中 +10<br>遠距攻擊 +5<br>魔攻 +5<br>防禦 -10<br>魔法防禦 +10<br>三段加速<br>時效: 600秒。","reel.ScrollEnchantArmorA":"強化失敗時，裝備不會消失。","reel.ScrollEnchantAccessoryA":"強化失敗時，裝備不會消失。","reel.ScrollEnchantWeaponA":"強化失敗時，裝備不會消失。","reel.AncientsMagicScroll":"增加防具的防禦力。","reel.AncientsAlchemyScroll":"增加武器的攻擊力。","power.PanaceaWis":"永久精神+1，全部種類只能使用 10 瓶。","power.PanaceaStr":"永久力量+1，全部種類只能使用 10 瓶。","power.PanaceaInt":"永久智力+1，全部種類只能使用 10 瓶。","power.PanaceaDex":"永久敏捷+1，全部種類只能使用 10 瓶。","power.PanaceaCon":"永久體力+1，全部種類只能使用 10 瓶。","power.PanaceaCha":"永久魅力+1，全部種類只能使用 10 瓶。","hp.Rabbit_Liver":"恢復600~700點體力。","hp.Power_Reply_potion6":"使用後自動扣除金幣並保留道具。","hp.Power_Reply_potion7":"使用後自動扣除金幣並保留道具。","hp.Power_Reply_potion8":"使用後自動扣除金幣並保留道具。","event.Item_Mazu":"使用後攻擊+1、狩獵經驗+10%，持續2400秒。","doll.Magic_Doll":"詳細說明請至遊戲資料庫查看。","brave.CakeChocolate2":"使用後自動扣除金幣並保留道具。",Box_Doll2:"使用後隨機獲得一個高階魔法娃娃",Blank_Check:"開出支票扣除1億金幣可獲得金磚，金磚使用後可兌換1億元金幣。",Battle_Reel:"使用後短暫提升角色能力<br>攻擊成功 +3<br>額外攻擊 +3<br>遠距命中 +3<br>遠距攻擊 +3<br>魔攻 +3<br>時效: 3600秒。",Ancient_Jade:"增加1個帳號角色數量上限。","mp.Mpr4":"可以恢復一些的魔力，由鍊金術之石產生。","extra.RingsExpansionGem":"擴充角色戒指欄位。","extra.EarringsExpansionGem":"擴充角色耳環欄位。"};const classChinese=classMap[item.classname]||"";const itemDesc=descMap[item.itemdesc_id]||"";card.innerHTML=`\n                <div class="item-card-content">\n                    <div class="item-icon">\n                        <img src="${iconPath}" alt="${item.name}">\n                    </div>\n                    <div class="item-name">${blessSDisplay}${item.name}</div>\n                </div>\n                <div class="item-stats">\n                    ${uselvlDisplay}\n                    類型: ${typeInChinese} <br>\n                    材質: ${materialInChinese} <br>\n                    ${weightDisplay}\n                    ${maxchargecountDisplay}\n                    ${itemdmgDisplay}\n                    ${delaytimeDisplay}\n                    ${stackableDisplay||tradeableDisplay||deleteableDisplay||delayEffectDisplay?`備註:<br>`:""}\n                    ${stackableDisplay}\n                    ${tradeableDisplay}\n                    ${deleteableDisplay}\n                    ${delayEffectDisplay}\n                    ${classChinese?`<div>${classChinese}</div>`:""}\n                    ${petitemDescription}\n                    <div class="item-desc">${itemDesc}</div>\n                </div>\n            `;card.dataset.type=item.item_type;fragment.appendChild(card)}));itemGrid.innerHTML="";itemGrid.appendChild(fragment)}function parseTblFile(tblContent){const lines=tblContent.trim().split("\n");const descMap={};lines.forEach((line=>{const parts=line.trim().split(/\s+/);const id=parts[0];const description=parts.slice(1).join(" ");descMap[id]=description}));return descMap}Promise.all([fetch(csvFilePath).then((response=>response.text())),fetch(tblFilePath).then((response=>response.text()))]).then((([csvText,tblText])=>{const rows=csvText.trim().split("\n");const headers=rows[0].split(",");const items=rows.slice(1).map((row=>{const values=row.split(",");let item={};headers.forEach(((header,index)=>{item[header.replace(/"/g,"")]=values[index].replace(/"/g,"")}));return item}));const descMap=parseTblFile(tblText);itemsCache=items;descMapCache=descMap;renderitems(items,descMap)})).catch((error=>{console.error("Error fetching or parsing CSV file:",error)}));const searchButton=document.querySelector(".search-bar button");const searchInput=document.querySelector(".search-bar input");searchButton.addEventListener("click",(function(){const searchTerm=searchInput.value.toLowerCase();const filteredItems=itemsCache.filter((item=>{const itemName=item.name.toLowerCase();return itemName.includes(searchTerm)}));renderitems(filteredItems,descMapCache)}));const categoryButtons=document.querySelectorAll(".category-btn");categoryButtons.forEach((button=>{button.addEventListener("click",(function(){const type=this.textContent;const itemCards=document.querySelectorAll(".item-card");itemCards.forEach((card=>{const itemType=card.querySelector(".item-stats").textContent.includes(`類型: ${type}`);if(type==="所有"||itemType){card.style.display="block"}else{card.style.display="none"}}))}))}))}));